================================================================================
Soda - SillyTavern TTS Extension
================================================================================

[1] í´ë” êµ¬ì¡°
================================================================================

Soda/
â”œâ”€ index.js                 # ST í™•ì¥ ë©”ì¸ ì§„ì…ì  (manifest.jsonì—ì„œ ì§€ì •)
â”œâ”€ manifest.json
â”œâ”€ style.css
â”‚
â”œâ”€ docs/
â”‚   â””â”€ SODA_ARCHITECTURE.txt        # í˜„ì¬ íŒŒì¼
â”‚
â”œâ”€ templates/
â”‚   â””â”€ settings.html        # ì„¤ì • íŒ¨ë„ HTML (Extensions ë©”ë‰´ìš©)
â”‚
â””â”€ modules/
    â”œâ”€ [ì½”ì–´ ëª¨ë“ˆ]
    â”‚   â”œâ”€ deps.js          # ST ì˜ì¡´ì„± ë¡œë” (extension_settings, saveSettingsDebounced)
    â”‚   â”œâ”€ settings.js      # ì„¤ì • ìŠ¤í‚¤ë§ˆ/ê¸°ë³¸ê°’/ë§ˆì´ê·¸ë ˆì´ì…˜
    â”‚   â””â”€ state.js         # TTS ì¬ìƒ ìƒíƒœ ê´€ë¦¬ + ìœ í‹¸ í•¨ìˆ˜ í¬í•¨
    â”‚
    â”œâ”€ [UI ëª¨ë“ˆ]
    â”‚   â”œâ”€ ui_settings.js       # ì„¤ì • íŒ¨ë„ UI + ì´ë²¤íŠ¸
    â”‚   â””â”€ ui_message_button.js # AI ë©”ì‹œì§€ ğŸ”Š ë²„íŠ¼ + MutationObserver
    â”‚
    â””â”€ providers/
        â”œâ”€ index.js         # í”„ë¡œë°”ì´ë” ë ˆì§€ìŠ¤íŠ¸ë¦¬
        â”œâ”€ qwen.js          # Qwen (Alibaba DashScope)
        â”œâ”€ openai.js        # OpenAI TTS
        â”œâ”€ gemini.js        # Google Gemini
        â”œâ”€ lmnt.js          # LMNT
        â””â”€ elevenlabs.js    # ElevenLabs


[2] ëª¨ë“ˆ ì—­í•  ìƒì„¸
================================================================================

[2-A] ì½”ì–´ ëª¨ë“ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
deps.js (~100ì¤„)
  - STì˜ extension_settings, saveSettingsDebounced, getRequestHeaders resolve
  - ì„¤ì¹˜ ê²½ë¡œ ì°¨ì´ ëŒ€ì‘ (third-party vs ì¼ë°˜)
  - getSTContextSafe(): ST ì»¨í…ìŠ¤íŠ¸ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°

settings.js (~200ì¤„)
  - SETTINGS_KEY ì •ì˜ ("soda_tts")
  - ensureSettings(): ì„¤ì • ê°ì²´ ì´ˆê¸°í™”/ë³´ì •
  - ê¸°ë³¸ê°’ ìŠ¤í‚¤ë§ˆ:
    * provider: í˜„ì¬ ì„ íƒëœ í”„ë¡œë°”ì´ë”
    * providers: { qwen, openai, gemini, lmnt, elevenlabs } ê°ê°ì˜ ì„¤ì •
    * msgButtonEnabled: ë©”ì‹œì§€ ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€
    * msgButtonReadMode: "dialogue" | "full"
    * autoPlay: ìë™ ì¬ìƒ ì—¬ë¶€ (í–¥í›„ ê¸°ëŠ¥ìš©)

state.js (~250ì¤„)
  - ì¬ìƒ ìƒíƒœ ê´€ë¦¬:
    * currentAudio: í˜„ì¬ ì¬ìƒ ì¤‘ì¸ Audio ê°ì²´
    * currentPlayingBtn: í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë²„íŠ¼ ìš”ì†Œ
    * lastAudioBlob: ë§ˆì§€ë§‰ ì¬ìƒ ì˜¤ë””ì˜¤ (ë‹¤ìš´ë¡œë“œìš©)
  - ìœ í‹¸ í•¨ìˆ˜:
    * preprocessForTts(text): TTS ì „ì²˜ë¦¬ (ë§ˆí¬ë‹¤ìš´/ì´ëª¨ì§€ ì œê±°)
    * extractDialogues(text): ëŒ€ì‚¬ë§Œ ì¶”ì¶œ
    * stripMarkdown(text): ë§ˆí¬ë‹¤ìš´ ì œê±°
    * stripEmoji(text): ì´ëª¨ì§€ ì œê±°

[2-B] UI ëª¨ë“ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ui_settings.js (~500ì¤„)
  - Extensions ë©”ë‰´ ë‚´ ì„¤ì • íŒ¨ë„ ì´ˆê¸°í™”
  - Provider ì„ íƒ/ì„¤ì • UI
  - ê° Providerë³„ ì„¤ì • í¼ (API Key, Voice, Model ë“±)
  - í…ŒìŠ¤íŠ¸ ë²„íŠ¼ / ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
  - ë©”ì‹œì§€ ë²„íŠ¼ í† ê¸€ + ì½ê¸° ëª¨ë“œ ì„ íƒ

ui_message_button.js (~350ì¤„)
  - AI ë©”ì‹œì§€ì— ğŸ”Š ë²„íŠ¼ ì‚½ì… (ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹)
  - MutationObserverë¡œ ìƒˆ ë©”ì‹œì§€ ê°ì§€
  - ST ì´ë²¤íŠ¸ ì—°ë™ (CHAT_CHANGED, CHARACTER_MESSAGE_RENDERED)
  - playTts(): Provider í˜¸ì¶œ â†’ Audio ì¬ìƒ
  - setMessageButtonsEnabled(): í† ê¸€ on/off

[2-C] Providers
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
index.js (~50ì¤„)
  - í”„ë¡œë°”ì´ë” ë ˆì§€ìŠ¤íŠ¸ë¦¬: providers ê°ì²´
  - getProvider(id), getProviderList()

qwen.js (~100ì¤„)
  - Alibaba DashScope API
  - Qwen3-TTS ëª¨ë¸ (qwen3-tts-flash, qwen3-tts)
  - ì‘ë‹µ: JSONì—ì„œ audio.url ì¶”ì¶œ

openai.js (~90ì¤„)
  - OpenAI TTS API
  - ëª¨ë¸: tts-1, tts-1-hd, gpt-4o-mini-tts
  - ì‘ë‹µ: ë°”ì´ë„ˆë¦¬ mp3 â†’ blob URL

gemini.js (~180ì¤„)
  - Google Gemini API
  - PCM â†’ WAV ë³€í™˜ í•„ìš”
  - ë¬´ë£Œ í‹°ì–´ í™œìš© ê°€ëŠ¥

lmnt.js (~150ì¤„)
  - LMNT API
  - JSON base64 ì‘ë‹µ ì²˜ë¦¬

elevenlabs.js (~160ì¤„)
  - ElevenLabs API
  - ë‹¤ì–‘í•œ ëª¨ë¸/ë³´ì´ìŠ¤ ì§€ì›
  - stability, similarity_boost íŒŒë¼ë¯¸í„°


[3] ì˜ì¡´ì„± ë°©í–¥ (ë‹¨ë°©í–¥ë§Œ í—ˆìš©)
================================================================================

ui_settings.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
ui_message_button.js â”€â”€â”€â”¼â”€â”€â–¶ settings, state, deps
                        â”‚
providers/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â–¶ deps (getRequestHeadersë§Œ ì‚¬ìš©)

settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ deps (extension_settings, saveSettingsDebounced)
state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ (ë…ë¦½, ë‹¤ë¥¸ ëª¨ë“ˆ import ì—†ìŒ)
deps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ (ë…ë¦½, ST ì „ì—­ë§Œ ì ‘ê·¼)

ìˆœí™˜ ì˜ì¡´ ê¸ˆì§€: A â†’ B â†’ A í˜•íƒœ ë¶ˆê°€


[4] í˜¸ì¶œ íë¦„
================================================================================

[í™•ì¥ ë¡œë“œ]
index.js (ST ì§„ì…ì )
  â””â”€â–¶ ì˜ì¡´ì„± resolve (deps.js: __sodaResolveDeps)
  â””â”€â–¶ ì„¤ì • ì´ˆê¸°í™” (settings.js: ensureSettings)
  â””â”€â–¶ settings.html ë¡œë“œ â†’ Extensions ë©”ë‰´ì— ì‚½ì…
  â””â”€â–¶ ui_settings.js: initSettingsPanel()
  â””â”€â–¶ ui_message_button.js: initMessageButtons()

[ì„¤ì • íŒ¨ë„ ì—´ê¸°]
Extensions ë©”ë‰´ â†’ Soda ì„¹ì…˜ í¼ì¹¨
  â””â”€â–¶ ui_settings.js: ì´ë²¤íŠ¸ ë°”ì¸ë”© í™œì„±í™”

[TTS ë©”ì‹œì§€ ë²„íŠ¼ í´ë¦­]
ğŸ”Š ë²„íŠ¼ í´ë¦­ (ì´ë²¤íŠ¸ ìœ„ì„)
  â””â”€â–¶ ui_message_button.js: playTts()
      â””â”€â–¶ í…ìŠ¤íŠ¸ ì¶”ì¶œ (dialogue/full ëª¨ë“œ)
      â””â”€â–¶ state.js: preprocessForTts()
      â””â”€â–¶ providers/index.js â†’ í•´ë‹¹ provider.getAudioUrl()
      â””â”€â–¶ Audio ì¬ìƒ
      â””â”€â–¶ stateì— lastAudioBlob ì €ì¥


[5] íŒŒì¼ ìˆ˜ì • ê°€ì´ë“œ
================================================================================

"ì´ ê¸°ëŠ¥ ê³ ì¹˜ë ¤ë©´ ì´ íŒŒì¼ë§Œ ë³´ë©´ ë¨"

ê¸°ëŠ¥                          íŒŒì¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ST ì˜ì¡´ì„± ë¡œë“œ                deps.js
ì„¤ì • ìŠ¤í‚¤ë§ˆ/ê¸°ë³¸ê°’            settings.js
ì¬ìƒ ìƒíƒœ/ìœ í‹¸ í•¨ìˆ˜           state.js
ì„¤ì • íŒ¨ë„ UI                  ui_settings.js
ë©”ì‹œì§€ TTS ë²„íŠ¼               ui_message_button.js
í”„ë¡œë°”ì´ë” ì¶”ê°€               providers/ìƒˆê±°.js + providers/index.js


[6] ê·œì¹™
================================================================================

[6-1] íŒŒì¼ í¬ê¸°
- ìµœì†Œ 50ì¤„(providers), ì¼ë°˜ 200-400ì¤„, ìµœëŒ€ 600ì¤„ ê¶Œì¥
- ë„ˆë¬´ ì‘ìœ¼ë©´ í•©ì¹˜ê³ , ë„ˆë¬´ í¬ë©´ ë¶„ë¦¬
- providersëŠ” ì˜ˆì™¸ì ìœ¼ë¡œ 100ì¤„ ë‚´ì™¸ í—ˆìš© (ê°ê° ë…ë¦½ì ì´ë¯€ë¡œ)

[6-2] ê¸ˆì§€ì‚¬í•­
- ìˆœí™˜ ì˜ì¡´
- providersì—ì„œ UI ëª¨ë“ˆ import
- state.jsì—ì„œ ë‹¤ë¥¸ ëª¨ë“ˆ import (ë…ë¦½ ìœ ì§€)

[6-3] ë„¤ì´ë° ê·œì¹™
- CSS í´ë˜ìŠ¤: soda- ì ‘ë‘ì‚¬ (ì˜ˆ: soda-msg-tts-btn)
- HTML ID: soda_ ì ‘ë‘ì‚¬ (ì˜ˆ: soda_tts_provider)
- ì„¤ì • í‚¤: SETTINGS_KEY = "soda_tts"
- ì½˜ì†” ë¡œê·¸: [Soda] ì ‘ë‘ì‚¬


[7] MyaoPlayì—ì„œ ê°€ì ¸ì˜¬ íŒŒì¼ ë§¤í•‘
================================================================================

MyaoPlay                          â†’  Soda
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
modules/deps.js                   â†’  modules/deps.js (ê²½ëŸ‰í™”)
modules/settings.js               â†’  modules/settings.js (TTS ë¶€ë¶„ë§Œ)
modules/utils.js (ì¼ë¶€)           â†’  modules/state.jsì— ë³‘í•©
modules/settings_modal/tts.js     â†’  modules/ui_settings.js
modules/tts/tts_message_button.js â†’  modules/ui_message_button.js
modules/tts/providers/*           â†’  modules/providers/* (ê·¸ëŒ€ë¡œ)

[ë³€ê²½ í•„ìš” ì‚¬í•­]
- ID ì ‘ë‘ì‚¬: abgm_ â†’ soda_
- CSS í´ë˜ìŠ¤: myaoplay- â†’ soda-
- ì½˜ì†” ë¡œê·¸: [MyaPl] â†’ [Soda]
- SETTINGS_KEY: "autobgm" â†’ "soda_tts"
- í•¨ìˆ˜ëª…: __abgmResolveDeps â†’ __sodaResolveDeps


[8] í–¥í›„ í™•ì¥ ê³ ë ¤
================================================================================

[8-1] ìë™ TTS (Auto-play)
- ìƒˆ AI ë©”ì‹œì§€ ê°ì§€ ì‹œ ìë™ ì¬ìƒ
- settings.autoPlay í”Œë˜ê·¸ë¡œ ì œì–´
- CHARACTER_MESSAGE_RENDERED ì´ë²¤íŠ¸ í™œìš©

[8-2] ì—°ì† ì¬ìƒ (Queue)
- ê¸´ í…ìŠ¤íŠ¸ë¥¼ ì²­í¬ë¡œ ë¶„í• í•˜ì—¬ ìˆœì°¨ ì¬ìƒ
- state.jsì— queue ê´€ë¦¬ ë¡œì§ ì¶”ê°€

[8-3] ìºë¦­í„°ë³„ ìŒì„± ë§¤í•‘
- ìºë¦­í„° ì´ë¦„/IDë³„ë¡œ ë‹¤ë¥¸ voice ì„¤ì •
- settingsì— voiceMap: { [charName]: voiceId } ì¶”ê°€

================================================================================